{
  "hash": "1ccdefe071db3284ed18af24066f9fa2",
  "result": {
    "markdown": "# 7. Nutzungsintensität\n\n\n\n\n\nNeue packages die wir für die Modelle und die Diagnostics brauchen\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# neue Packages: DHARMa, car, MASS, ROCR, sjPlot, sjstats, rms, ggeffects,\n# cowplot\n\nipak <- function(pkg) {\n    new.pkg <- pkg[!(pkg %in% installed.packages()[, \"Package\"])]\n    if (length(new.pkg))\n        install.packages(new.pkg, repos = \"http://cran.us.r-project.org\", dependencies = TRUE)\n    sapply(pkg, require, character.only = TRUE)\n}\n\npackages <- c(\"lme4\", \"bbmle\", \"MuMIn\", \"tidyverse\", \"DHARMa\", \"car\", \"MASS\", \"ROCR\",\n    \"sjPlot\", \"rms\", \"ggeffects\", \"sjstats\", \"cowplot\", \"glmmTMB\", \"performance\",\n    \"kableExtra\")\n\nipak(packages)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nDF_mod_day <- read_delim(\"data/Aufgabe4_Datensatz_Habitatnutzung_Modelle_20211101_moodle.csv\",\n    delim = \";\") %>%\n    filter(time_of_day == \"day\") %>%\n    mutate(slope_scaled = scale(slope), us_scaled = scale(us), os_scaled = scale(os),\n        forest_prop_scaled = scale(forest_prop), dist_road_scaled = scale(dist_road_all),\n        dist_road_only_scaled = scale(dist_road_only), dist_build_scaled = scale(dist_build),\n        id = as.factor(id))\n```\n:::\n\n\n- Ursprüngliche Funktion und Modelformel\n\n\n::: {.cell ridy='true'}\n\n```{.r .cell-code}\n# glmer(formula, data = , family = binomial)\n\n# 1) formula: \n# Abhängige Variable ~ Erklärende Variable + Random Factor \n# In unseren Modellen kontrollieren wir für individuelle Unterschiede bei den Rehen \n# indem wir einen Random Factor definieren => (1 | id) \n\n# 2) data: \n# euer Datensatz\n\n# 3) family: \n# binomial\n\n# Verteilung der abhängigen Variable bei der Nutzungsintensität aus?\n\nggplot(DF_mod_day, aes(nmb)) + geom_histogram()\n```\n\n::: {.cell-output-display}\n![](7_Modelle_mit_Nutzungsintensitaet_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n- Hinsichtlich der Nutzungsintensität müssen wir die Formel erweitern:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Erweiterung um einen sog. Offset-Term, der hier gebraucht wird, um für die\n# Anzahl der GPS Lokalisationen (in der Spalte GPStot aufgeführt) zu korrigeren\n# (eigentlich eine Skalierung der abhängigen Variable um die relative\n# Nutzungsintensität zu modellieren)\n\nf_count <- nmb ~ slope_scaled + dist_road_scaled + forest_prop_scaled + os_scaled +\n    us_scaled + dist_build_scaled + offset(log(GPStot)) + (1 | id)\n\n### Für die Nutzungsintensität brauchen wir ein neues package (glmmTMB) um das\n### GLMM fitten zu können. glmer kann leider mit der negativ binomial -\n### Verteilung nicht in jedem Fall umgehen.\n\nm <- glmmTMB(f_count, data = DF_mod_day, family = glmmTMB::nbinom2(), na.action = \"na.fail\")\n\n# Das Modell in die dredge-Funktion einfügen (siehe auch unbedingt ?dredge)\n\nall_m <- dredge(m)\n\navgmodel <- model.avg(all_m, rank = \"AICc\", subset = delta < 2)\nsummary(avgmodel)\n```\n:::\n\n\n- Model testing for over/underdispersion, zeroinflation and spatial autocorrelation following the DHARMa package.\n- unbedingt die Vignette des DHARMa-Package konsultieren: [Link](https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html)\n\n\n::: {.cell}\n\n```{.r .cell-code}\nf_count <- nmb ~ slope_scaled + dist_road_scaled + forest_prop_scaled + os_scaled +\n    us_scaled + offset(log(GPStot)) + (1 | id)\n\n### Für die Nutzungsintensität brauchen wir ein neues package (glmmTMB) um das\n### GLMM fitten zu können. glmer kann leider mit der negativ binomial -\n### Verteilung nicht in jedem Fall umgehen.\n\nm_day_count <- glmmTMB(f_count, data = DF_mod_day, family = glmmTMB::nbinom2())\n\nsummary(m_day_count)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n Family: nbinom2  ( log )\nFormula:          nmb ~ slope_scaled + dist_road_scaled + forest_prop_scaled +  \n    os_scaled + us_scaled + offset(log(GPStot)) + (1 | id)\nData: DF_mod_day\n\n     AIC      BIC   logLik deviance df.resid \n 11478.3  11529.0  -5731.2  11462.3     4177 \n\nRandom effects:\n\nConditional model:\n Groups Name        Variance Std.Dev.\n id     (Intercept) 1.608    1.268   \nNumber of obs: 4185, groups:  id, 12\n\nDispersion parameter for nbinom2 family (): 0.376 \n\nConditional model:\n                   Estimate Std. Error z value Pr(>|z|)    \n(Intercept)        -6.02497    0.36778 -16.382  < 2e-16 ***\nslope_scaled       -0.17888    0.04656  -3.842 0.000122 ***\ndist_road_scaled    0.66387    0.04489  14.788  < 2e-16 ***\nforest_prop_scaled  0.53649    0.05207  10.303  < 2e-16 ***\nos_scaled           0.18699    0.05157   3.626 0.000288 ***\nus_scaled           0.38644    0.03568  10.832  < 2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n\n```{.r .cell-code}\ntab_model(m_day_count, transform = NULL, show.se = T)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table style=\"border-collapse:collapse; border:none;\">\n<tr>\n<th style=\"border-top: double; text-align:center; font-style:normal; font-weight:bold; padding:0.2cm;  text-align:left; \">&nbsp;</th>\n<th colspan=\"4\" style=\"border-top: double; text-align:center; font-style:normal; font-weight:bold; padding:0.2cm; \">nmb</th>\n</tr>\n<tr>\n<td style=\" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  text-align:left; \">Predictors</td>\n<td style=\" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  \">Log-Mean</td>\n<td style=\" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  \">std. Error</td>\n<td style=\" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  \">CI</td>\n<td style=\" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  \">p</td>\n</tr>\n<tr>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; \">(Intercept)</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">&#45;6.02</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">0.37</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">&#45;6.75&nbsp;&ndash;&nbsp;-5.30</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \"><strong>&lt;0.001</strong></td>\n</tr>\n<tr>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; \">slope scaled</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">&#45;0.18</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">0.05</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">&#45;0.27&nbsp;&ndash;&nbsp;-0.09</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \"><strong>&lt;0.001</strong></td>\n</tr>\n<tr>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; \">dist road scaled</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">0.66</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">0.04</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">0.58&nbsp;&ndash;&nbsp;0.75</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \"><strong>&lt;0.001</strong></td>\n</tr>\n<tr>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; \">forest prop scaled</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">0.54</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">0.05</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">0.43&nbsp;&ndash;&nbsp;0.64</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \"><strong>&lt;0.001</strong></td>\n</tr>\n<tr>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; \">os scaled</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">0.19</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">0.05</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">0.09&nbsp;&ndash;&nbsp;0.29</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \"><strong>&lt;0.001</strong></td>\n</tr>\n<tr>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; \">us scaled</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">0.39</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">0.04</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \">0.32&nbsp;&ndash;&nbsp;0.46</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  \"><strong>&lt;0.001</strong></td>\n</tr>\n<tr>\n<td colspan=\"5\" style=\"font-weight:bold; text-align:left; padding-top:.8em;\">Random Effects</td>\n</tr>\n\n<tr>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;\">&sigma;<sup>2</sup></td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;\" colspan=\"4\">5.64</td>\n</tr>\n\n<tr>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;\">&tau;<sub>00</sub> <sub>id</sub></td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;\" colspan=\"4\">1.61</td>\n\n<tr>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;\">ICC</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;\" colspan=\"4\">0.22</td>\n\n<tr>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;\">N <sub>id</sub></td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;\" colspan=\"4\">12</td>\n<tr>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm; border-top:1px solid;\">Observations</td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left; border-top:1px solid;\" colspan=\"4\">4185</td>\n</tr>\n<tr>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;\">Marginal R<sup>2</sup> / Conditional R<sup>2</sup></td>\n<td style=\" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;\" colspan=\"4\">0.131 / 0.324</td>\n</tr>\n\n</table>\n\n`````\n:::\n\n```{.r .cell-code}\n# Residuals werden über eine Simulation auf eine Standard-Skala transformiert\n# und kännen anschliessend getestet werden. Dabei kann die Anzahl Simulationen\n# eingestellt werden (dauert je nach dem sehr lange)\n\nsimulationOutput <- simulateResiduals(fittedModel = m_day_count, n = 10000)\n\n# plotting and testing scaled residuals\n\nplot(simulationOutput)\n```\n\n::: {.cell-output-display}\n![](7_Modelle_mit_Nutzungsintensitaet_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\ntestResiduals(simulationOutput)\n```\n\n::: {.cell-output-display}\n![](7_Modelle_mit_Nutzungsintensitaet_files/figure-html/unnamed-chunk-6-2.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n$uniformity\n\n\tAsymptotic one-sample Kolmogorov-Smirnov test\n\ndata:  simulationOutput$scaledResiduals\nD = 0.082405, p-value < 2.2e-16\nalternative hypothesis: two-sided\n\n\n$dispersion\n\n\tDHARMa nonparametric dispersion test via sd of residuals fitted vs.\n\tsimulated\n\ndata:  simulationOutput\ndispersion = 0.012257, p-value = 0.0854\nalternative hypothesis: two.sided\n\n\n$outliers\n\n\tDHARMa outlier test based on exact binomial test with approximate\n\texpectations\n\ndata:  simulationOutput\noutliers at both margin(s) = 9, observations = 4185, p-value =\n2.603e-07\nalternative hypothesis: true probability of success is not equal to 0.00019998\n95 percent confidence interval:\n 0.0009838195 0.0040784476\nsample estimates:\nfrequency of outliers (expected: 0.0001999800019998 ) \n                                          0.002150538 \n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n$uniformity\n\n\tAsymptotic one-sample Kolmogorov-Smirnov test\n\ndata:  simulationOutput$scaledResiduals\nD = 0.082405, p-value < 2.2e-16\nalternative hypothesis: two-sided\n\n\n$dispersion\n\n\tDHARMa nonparametric dispersion test via sd of residuals fitted vs.\n\tsimulated\n\ndata:  simulationOutput\ndispersion = 0.012257, p-value = 0.0854\nalternative hypothesis: two.sided\n\n\n$outliers\n\n\tDHARMa outlier test based on exact binomial test with approximate\n\texpectations\n\ndata:  simulationOutput\noutliers at both margin(s) = 9, observations = 4185, p-value =\n2.603e-07\nalternative hypothesis: true probability of success is not equal to 0.00019998\n95 percent confidence interval:\n 0.0009838195 0.0040784476\nsample estimates:\nfrequency of outliers (expected: 0.0001999800019998 ) \n                                          0.002150538 \n```\n:::\n\n```{.r .cell-code}\n# The most common concern for GLMMs is overdispersion, underdispersion and\n# zero-inflation.\n\n# separate test for dispersion\n\ntestDispersion(simulationOutput)\n```\n\n::: {.cell-output-display}\n![](7_Modelle_mit_Nutzungsintensitaet_files/figure-html/unnamed-chunk-6-3.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tDHARMa nonparametric dispersion test via sd of residuals fitted vs.\n\tsimulated\n\ndata:  simulationOutput\ndispersion = 0.012257, p-value = 0.0854\nalternative hypothesis: two.sided\n```\n:::\n\n```{.r .cell-code}\n# test for Zeroinflation\n\ntestZeroInflation(simulationOutput)\n```\n\n::: {.cell-output-display}\n![](7_Modelle_mit_Nutzungsintensitaet_files/figure-html/unnamed-chunk-6-4.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tDHARMa zero-inflation test via comparison to expected zeros with\n\tsimulation under H0 = fitted model\n\ndata:  simulationOutput\nratioObsSim = 1.0277, p-value = 0.7286\nalternative hypothesis: two.sided\n```\n:::\n\n```{.r .cell-code}\n# test for spatial Autocorrelation\n\ndM = as.matrix(dist(cbind(DF_mod_day$x, DF_mod_day$y)))\n\ntestSpatialAutocorrelation(simulationOutput, distMat = dM, plot = F)\n```\n\n::: {.cell-output .cell-output-error}\n```\nError in if (obs <= ei) 2 * pv else 2 * (1 - pv): Fehlender Wert, wo TRUE/FALSE nötig ist\n```\n:::\n\n```{.r .cell-code}\n# Testen auf Multicollinearität (dh zu starke Korrelationen im finalen Modell,\n# zB falls auf Grund der ökologsichen Plausibilität stark korrelierte Variablen\n# im Modell)\n#--> funktioniert bei glmmTMB Modellen mit dieser Funktion aus dem performace package:\n\ncheck_collinearity(m_day_count)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# Check for Multicollinearity\n\nLow Correlation\n\n               Term  VIF   VIF 95% CI Increased SE Tolerance Tolerance 95% CI\n       slope_scaled 1.41 [1.36, 1.47]         1.19      0.71     [0.68, 0.74]\n   dist_road_scaled 1.06 [1.03, 1.10]         1.03      0.94     [0.91, 0.97]\n forest_prop_scaled 1.66 [1.59, 1.73]         1.29      0.60     [0.58, 0.63]\n          os_scaled 2.03 [1.94, 2.13]         1.42      0.49     [0.47, 0.52]\n          us_scaled 1.21 [1.17, 1.26]         1.10      0.83     [0.80, 0.85]\n```\n:::\n:::\n\n\n- AUC funktioniert nicht bei nicht-binären abhängigen Variablen, daher müssen wir eine andere Möglichkeit finden um den Goodness-of-fit der Modelle abzuschätzen:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Zitat B.Bokler 2013: 'GLMMs are still part of the statistical frontier, and\n# not all of the answers about how to use them are known (even by experts)'\n\nr2(m_day_count)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# R2 for Mixed Models\n\n  Conditional R2: 0.324\n     Marginal R2: 0.131\n```\n:::\n:::\n\n\n- Plots der vorhergesagten relativen Nutzungsintensität funktionieren nach dem selben Prinzip das wir bereits kennen:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# graphische Darstellung der gesamten Modellresultate\n\nplot_model(m_day_count, transform = NULL, show.values = TRUE, value.offset = 0.3)\n```\n\n::: {.cell-output-display}\n![](7_Modelle_mit_Nutzungsintensitaet_files/figure-html/unnamed-chunk-8-1.png){width=480}\n:::\n\n```{.r .cell-code}\n# Plotten der vorhergesagten Wahrscheinlichkeit, dass ein Kreis besetzt ist, in\n# Abhängigkeit der erklärenden Variable basierend auf den Modellresultaten.\n\nplot_model(m_day_count, type = \"pred\", terms = \"dist_road_scaled\")\n```\n\n::: {.cell-output-display}\n![](7_Modelle_mit_Nutzungsintensitaet_files/figure-html/unnamed-chunk-8-2.png){width=480}\n:::\n\n```{.r .cell-code}\n# Problem: skalierte Variablen lassen sich nicht so ohne Weiteres plotten, hier\n# ein quick-and-dirty hack um das Problem zu umgehen. Die Einstellungen müssen\n# für jede Variable geändert werden\n\np <- plot_model(m_day_count, type = \"pred\", terms = \"dist_road_scaled\")\n\nlabels <- round(seq(floor(min(DF_mod_day$dist_road_all)), ceiling(max(DF_mod_day$dist_road_all)),\n    length.out = 6), 2)\n\np <- p + scale_x_continuous(breaks = c(-1, 0, 1, 2, 3, 4), labels = c(labels))\n\np\n```\n\n::: {.cell-output-display}\n![](7_Modelle_mit_Nutzungsintensitaet_files/figure-html/unnamed-chunk-8-3.png){width=480}\n:::\n:::\n",
    "supporting": [
      "7_Modelle_mit_Nutzungsintensitaet_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}