{
  "hash": "a76b7be478c4318d3de77ecd9a36562e",
  "result": {
    "markdown": "# 6. Lösung\n\n\n\n\n::: {.cell}\n\n:::\n\n\n\n\n\n## Modellgüte und -diagnostics MM / Habitatselektionsmodell\n\n\n\n\n\n### Libraries laden\n\nNeue packages die wir für die Modelle und die Diagnostics brauchen\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# neue Packages: DHARMa, car, MASS, ROCR, sjPlot, sjstats,\n# ggeffects, cowplot, gstat\n\nipak <- function(pkg) {\n    new.pkg <- pkg[!(pkg %in% installed.packages()[, \"Package\"])]\n    if (length(new.pkg))\n        install.packages(new.pkg, repos = \"http://cran.us.r-project.org\",\n            dependencies = TRUE)\n    sapply(pkg, require, character.only = TRUE)\n}\n\npackages <- c(\"lme4\", \"bbmle\", \"MuMIn\", \"tidyverse\", \"DHARMa\",\n    \"car\", \"MASS\", \"ROCR\", \"sjPlot\", \"ggeffects\", \"sjstats\",\n    \"cowplot\", \"magrittr\", \"gstat\")\n\nipak(packages)\n```\n:::\n\n\n### Ausgangslage\n\n- Der Modellfit von letzter Woche als Ausgangspunkt für die heutige Übung\n\n\n::: {.cell}\n\n```{.r .cell-code}\nDF_mod_day <- read_delim(here(\"data\", \"Aufgabe4_Datensatz_Habitatnutzung_Modelle_20211101_moodle.csv\"),\n    delim = \";\") %>%\n    filter(time_of_day == \"day\") %>%\n    mutate(slope_scaled = scale(slope), us_scaled = scale(us),\n        os_scaled = scale(os), forest_prop_scaled = scale(forest_prop),\n        dist_road_all_scaled = scale(dist_road_all), dist_road_only_scaled = scale(dist_road_only),\n        dist_build_scaled = scale(dist_build), id = as.factor(id))\n\nf <- pres_abs ~ slope_scaled + us_scaled + os_scaled + forest_prop_scaled +\n    dist_road_only_scaled + dist_build_scaled\n\nf <- paste(c(f, \"+ (1 | id)\"), collapse = \" \") %>%\n    as.formula()\n\nm_day <- glmer(f, data = DF_mod_day, family = binomial, na.action = \"na.fail\")\n\nall_m <- dredge(m_day)\n\navgmodel <- model.avg(all_m, rank = \"AICc\", subset = delta <\n    2)\nsummary(avgmodel)\n```\n:::\n\n\n- Die Modellresultate aus dem avgmodel sind grundätzlich die finalen Resultate die bereits interpretiert werden könnten. Allerdings funktionieren die Diagnosetests und die Darstellung der Resultate mit diesem gemittelten Modell nicht sehr gut, weshalb wir einen re-fit mit glmer machen müssen (an den Resultaten ändert sich dadurch nichts) \n\n\n::: {.cell}\n\n```{.r .cell-code}\nf_pres_abs <- pres_abs ~ dist_build_scaled + dist_road_only_scaled +\n    forest_prop_scaled + slope_scaled + us_scaled + os_scaled +\n    (1 | id)\n\nm_day <- glmer(f_pres_abs, data = DF_mod_day, family = binomial,\n    na.action = \"na.fail\")\n\n# hier noch zum Vergleich, dass die Resulate sich nur\n# marginal verändern\n\nsummary(avgmodel)\nsummary(m_day)\n\n# https://stats.stackexchange.com/questions/153611/interpreting-random-effect-variance-in-glmer\n\n# 95% range of the roe deer effects is approximately: -0.97\n# - 0.97\n```\n:::\n\n\n### Aufgabe 1\n\nBerechung der AUC (area under the receiver operating characteristic curve)**= Mass der Modellgüte**\n\nFür die Berechnung des AUC findet ihr weiterführende Informationen unter: [Link](https://www.wsl.ch/staff/niklaus.zimmermann/programs/progs/simtest.pdf) \n\n\n::: {.cell}\n\n```{.r .cell-code}\nprob <- predict(m_day, type = c(\"response\"))\npred <- prediction(prob, DF_mod_day$pres_abs)\n\n# AUC\n\nauc <- performance(pred, measure = \"auc\")@y.values[[1]]\nauc\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 0.7769194\n```\n:::\n:::\n\n\n### Aufgabe 2\n\nInterpretieren der Modell-Residuen mittels Tests auf verschiedene Aspekte\n\n- Model testing for over/underdispersion, zeroinflation and spatial autocorrelation following the DHARMa package.\n- unbedingt die Vignette des DHARMa-Package konsultieren: [Link](https://cran.r-project.org/web/packages/DHARMa/vignettes/DHARMa.html)\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Residuals werden über eine Simulation auf eine\n# Standard-Skala transformiert und können anschliessend\n# getestet werden. Dabei kann die Anzahl Simulationen\n# eingestellt werden (dauert je nach dem sehr lange)\n\nsimulationOutput <- simulateResiduals(fittedModel = m_day, n = 10000)\n\n# plotting and testing scaled residuals\n\nplot(simulationOutput)\n```\n\n::: {.cell-output-display}\n![](6_Guete_und_Diagnostics_Loesung_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n\n```{.r .cell-code}\ntestResiduals(simulationOutput)\n```\n\n::: {.cell-output-display}\n![](6_Guete_und_Diagnostics_Loesung_files/figure-html/unnamed-chunk-6-2.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n$uniformity\n\n\tAsymptotic one-sample Kolmogorov-Smirnov test\n\ndata:  simulationOutput$scaledResiduals\nD = 0.02194, p-value = 0.03559\nalternative hypothesis: two-sided\n\n\n$dispersion\n\n\tDHARMa nonparametric dispersion test via sd of residuals fitted vs.\n\tsimulated\n\ndata:  simulationOutput\ndispersion = 0.9797, p-value = 0.4862\nalternative hypothesis: two.sided\n\n\n$outliers\n\n\tDHARMa outlier test based on exact binomial test with approximate\n\texpectations\n\ndata:  simulationOutput\noutliers at both margin(s) = 1, observations = 4185, p-value = 0.567\nalternative hypothesis: true probability of success is not equal to 0.00019998\n95 percent confidence interval:\n 6.049637e-06 1.330610e-03\nsample estimates:\nfrequency of outliers (expected: 0.0001999800019998 ) \n                                         0.0002389486 \n```\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n$uniformity\n\n\tAsymptotic one-sample Kolmogorov-Smirnov test\n\ndata:  simulationOutput$scaledResiduals\nD = 0.02194, p-value = 0.03559\nalternative hypothesis: two-sided\n\n\n$dispersion\n\n\tDHARMa nonparametric dispersion test via sd of residuals fitted vs.\n\tsimulated\n\ndata:  simulationOutput\ndispersion = 0.9797, p-value = 0.4862\nalternative hypothesis: two.sided\n\n\n$outliers\n\n\tDHARMa outlier test based on exact binomial test with approximate\n\texpectations\n\ndata:  simulationOutput\noutliers at both margin(s) = 1, observations = 4185, p-value = 0.567\nalternative hypothesis: true probability of success is not equal to 0.00019998\n95 percent confidence interval:\n 6.049637e-06 1.330610e-03\nsample estimates:\nfrequency of outliers (expected: 0.0001999800019998 ) \n                                         0.0002389486 \n```\n:::\n\n```{.r .cell-code}\n# The most common concern for GLMMs is overdispersion,\n# underdispersion and zero-inflation.\n\n# separate test for dispersion\n\ntestDispersion(simulationOutput)\n```\n\n::: {.cell-output-display}\n![](6_Guete_und_Diagnostics_Loesung_files/figure-html/unnamed-chunk-6-3.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tDHARMa nonparametric dispersion test via sd of residuals fitted vs.\n\tsimulated\n\ndata:  simulationOutput\ndispersion = 0.9797, p-value = 0.4862\nalternative hypothesis: two.sided\n```\n:::\n\n```{.r .cell-code}\n# test for Zeroinflation\n\ntestZeroInflation(simulationOutput)\n```\n\n::: {.cell-output-display}\n![](6_Guete_und_Diagnostics_Loesung_files/figure-html/unnamed-chunk-6-4.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tDHARMa zero-inflation test via comparison to expected zeros with\n\tsimulation under H0 = fitted model\n\ndata:  simulationOutput\nratioObsSim = 1.0388, p-value = 0.4544\nalternative hypothesis: two.sided\n```\n:::\n\n```{.r .cell-code}\n# test for spatial Autocorrelation\n\n# calculating x, y positions per group\ngroupLocations = aggregate(DF_mod_day[, 3:4], list(DF_mod_day$x,\n    DF_mod_day$y), mean)\ngroupLocations$group <- paste(groupLocations$Group.1, groupLocations$Group.2)\n\n# calculating residuals per group\nres2 = recalculateResiduals(simulationOutput, group = groupLocations$group)\n\n# running the spatial test on grouped residuals\ntestSpatialAutocorrelation(res2, groupLocations$x, groupLocations$y,\n    plot = F)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tDHARMa Moran's I test for distance-based autocorrelation\n\ndata:  res2\nobserved = 0.0149472, expected = -0.0002661, sd = 0.0010081, p-value <\n2.2e-16\nalternative hypothesis: Distance-based autocorrelation\n```\n:::\n\n```{.r .cell-code}\n# Testen auf Multicollinearität (dh zu starke Korrelationen\n# im finalen Modell, zB falls auf Grund der ökologischen\n# Plausibilität stark korrelierte Variablen im Modell) use\n# VIF values: if values less then 5 is ok (sometimes > 10),\n# if mean of VIF values not substantially greater than 1\n# (say 5), no need to worry.\n\ncar::vif(m_day)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n    dist_build_scaled dist_road_only_scaled    forest_prop_scaled \n             1.508604              1.129679              2.542465 \n         slope_scaled             us_scaled             os_scaled \n             1.500129              1.219237              2.455742 \n```\n:::\n\n```{.r .cell-code}\nmean(car::vif(m_day))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 1.725976\n```\n:::\n:::\n\n\n### Aufgabe 4 \n\nErmittlung des individuellen Beitrags der einzelen Variablen im Gesamtmodell\n\n- **Bestimmen delta AIC nach Coppes et al. 2017 -> Vergleich des Gesamtmodells gegenüber einem Modell ohne die entsprechende Variable.**\n- **Auftrag auf den 22.11.2021: Jede Gruppe kurze Vorstellung der Modellresultate & Diagnostics im Plenum und Diskussion der Ergebnisse (keine PP-Präsentation nötig)**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nm_os <- glmer(pres_abs ~ dist_build_scaled + dist_road_only_scaled +\n    forest_prop_scaled + slope_scaled + us_scaled + (1 | id),\n    data = DF_mod_day, family = binomial, na.action = \"na.fail\")\n\nm_us <- glmer(pres_abs ~ dist_build_scaled + dist_road_only_scaled +\n    forest_prop_scaled + slope_scaled + os_scaled + (1 | id),\n    data = DF_mod_day, family = binomial, na.action = \"na.fail\")\n\nm_road <- glmer(pres_abs ~ dist_build_scaled + forest_prop_scaled +\n    slope_scaled + us_scaled + os_scaled + (1 | id), data = DF_mod_day,\n    family = binomial, na.action = \"na.fail\")\n\nm_forest <- glmer(pres_abs ~ dist_build_scaled + dist_road_only_scaled +\n    slope_scaled + us_scaled + os_scaled + (1 | id), data = DF_mod_day,\n    family = binomial, na.action = \"na.fail\")\n\nm_build <- glmer(pres_abs ~ dist_build_scaled + dist_road_only_scaled +\n    forest_prop_scaled + slope_scaled + us_scaled + os_scaled +\n    (1 | id), data = DF_mod_day, family = binomial, na.action = \"na.fail\")\n\nm_slope <- glmer(pres_abs ~ dist_build_scaled + dist_road_only_scaled +\n    forest_prop_scaled + us_scaled + os_scaled + (1 | id), data = DF_mod_day,\n    family = binomial, na.action = \"na.fail\")\n\nbbmle::AICtab(m_day, m_os, m_us, m_road, m_forest, m_build, m_slope)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n         dAIC  df\nm_os       0.0 7 \nm_day      0.9 8 \nm_build    0.9 8 \nm_slope    7.3 7 \nm_us      92.2 7 \nm_road    94.3 7 \nm_forest 141.9 7 \n```\n:::\n:::\n",
    "supporting": [
      "6_Guete_und_Diagnostics_Loesung_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}